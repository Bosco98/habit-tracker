<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Habit: Cloud Sync</title>
    <meta name="description" content="Track daily habits with an interactive grid, XP insights, and optional Google Sheets sync inside the Habit Tracker web app.">
    <meta name="keywords" content="habit tracker, habit app, daily habits, productivity tracker, google sheets sync">
    <meta name="author" content="Habit Tracker">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://bosco98.github.io/habit-tracker/">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="Habit Tracker">
    <meta property="og:title" content="Habit Tracker Cloud Sync App">
    <meta property="og:description" content="Monitor streaks, XP, and trends while syncing habits to Google Sheets in minutes.">
    <meta property="og:url" content="https://bosco98.github.io/habit-tracker/">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Habit Tracker Cloud Sync App">
    <meta name="twitter:description" content="Monitor streaks, XP insights, and trend charts with seamless Google Sheets syncing.">
    <meta name="twitter:url" content="https://bosco98.github.io/habit-tracker/">
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@graph": [
            {
                "@type": "SoftwareApplication",
                "@id": "https://bosco98.github.io/habit-tracker/#app",
                "name": "Habit Tracker",
                "operatingSystem": "Web",
                "applicationCategory": "ProductivityApplication",
                "description": "Track daily habits with an interactive grid, XP insights, and optional Google Sheets sync.",
                "url": "https://bosco98.github.io/habit-tracker/",
                "offers": {
                    "@type": "Offer",
                    "price": "0",
                    "priceCurrency": "USD"
                },
                "publisher": {
                    "@id": "https://bosco98.github.io/habit-tracker/#organization"
                }
            },
            {
                "@type": "Organization",
                "@id": "https://bosco98.github.io/habit-tracker/#organization",
                "name": "Habit Tracker",
                "url": "https://bosco98.github.io/habit-tracker/",
                "description": "Habit Tracker helps people build momentum with data-driven daily habits and optional Google Sheets sync.",
                "sameAs": [
                    "https://x.com/Bosco9806",
                    "https://github.com/bosco98",
                    "https://www.linkedin.com/in/boscocorrea/"
                ],
                "contactPoint": [
                    {
                        "@type": "ContactPoint",
                        "contactType": "customer support",
                        "email": "bosco98123@gmail.com"
                    }
                ]
            }
        ]
    }
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Google API Client & Identity Services -->
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            margin: 0;
            min-height: 100vh;
        }

        .habit-grid {
            display: grid;
            grid-template-columns: 160px repeat(var(--days-cols), 1fr);
            overflow-x: auto;
        }

        .sticky-col {
            position: sticky;
            left: 0;
            background: white;
            z-index: 10;
            border-right: 2px solid #e2e8f0;
        }

        .cell {
            min-width: 35px;
            height: 35px;
            border: 1px solid #f1f5f9;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            font-size: 0.7rem;
        }

        .cell-check {
            cursor: pointer;
        }

        .cell-check:hover {
            background-color: #f1f5f9;
        }

        .habit-true {
            background-color: #bbf7d0 !important;
            color: #166534;
        }

        .habit-false {
            background-color: #fff;
            color: #cbd5e1;
        }

        .habit-vice.habit-true {
            background-color: #fee2e2 !important;
            color: #991b1b;
        }

        .habit-vice.habit-false {
            background-color: #fff !important;
            color: #cbd5e1;
        }

        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 50;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .chart-wrapper {
            position: relative;
            height: 280px;
            width: 100%;
        }

        .overflow-x-auto::-webkit-scrollbar {
            height: 8px;
        }

        .overflow-x-auto::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        .overflow-x-auto::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        .toggle-track {
            position: relative;
            display: inline-block;
            width: 36px;
            height: 20px;
            border-radius: 9999px;
            background-color: #cbd5f5;
            transition: background-color 0.2s;
        }

        .toggle-thumb {
            position: absolute;
            top: 50%;
            left: 4px;
            width: 16px;
            height: 16px;
            border-radius: 9999px;
            background-color: #ffffff;
            box-shadow: 0 1px 3px rgba(15, 23, 42, 0.25);
            transform: translate(0, -50%);
            transition: transform 0.2s;
        }

        #cloudSyncToggle:checked + .toggle-track {
            background-color: #2563eb;
        }

        #cloudSyncToggle:checked + .toggle-track .toggle-thumb {
            transform: translate(16px, -50%);
        }

        #cloudSyncToggle:focus-visible + .toggle-track {
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.4);
        }
    </style>
</head>

<body class="p-4 md:p-6">
    <div class="max-w-6xl mx-auto flex flex-col gap-6 pb-32">

        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
            <div>
                <h1 class="text-2xl font-bold text-slate-900">Habit Tracker</h1>
            </div>
            <div class="flex items-center gap-3">
                <div
                    class="bg-white px-4 h-12 rounded-lg shadow-sm border border-slate-200 text-right flex flex-col justify-center">
                    <p class="text-[10px] font-bold uppercase text-slate-400 leading-none">Total XP</p>
                    <p id="totalXP" class="text-xl font-black text-blue-600 leading-tight">0</p>
                </div>

                <button onclick="toggleHabitManager()"
                    class="bg-slate-800 text-white px-4 h-12 rounded-lg text-xs font-semibold hover:bg-slate-700 transition flex items-center justify-center">
                    Change Habits ‚úèÔ∏è
                </button>
                <button onclick="toggleAppSettingManager()"
                    class="bg-slate-800 text-white px-4 h-12 rounded-lg text-xs font-semibold hover:bg-slate-700 transition flex items-center justify-center">
                    ‚öôÔ∏è
                </button>
            </div>

        </header>

        <!-- Stats -->
        <section class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100">
                <h3 class="text-slate-400 text-[10px] font-bold uppercase mb-1">Top Performer</h3>
                <div id="bestHabit" class="text-base font-bold text-slate-800 truncate">Calculating...</div>
            </div>
            <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100">
                <h3 class="text-slate-400 text-[10px] font-bold uppercase mb-1">Monthly Completion</h3>
                <div id="completionRate" class="text-2xl font-black text-slate-800">0%</div>
            </div>
            <div id="sheetsSyncCard" class="bg-white p-4 rounded-xl shadow-sm border border-slate-100">
                <h3 class="text-slate-400 text-[10px] font-bold uppercase mb-1">Sheets sync</h3>
                <div id="apiStatusDisplay" class="text-sm font-bold text-red-500 mb-2">Not Configured</div>
                <div class="flex gap-1">
                    <button onclick="syncFromGoogle()"
                        class="flex-1 bg-green-600 text-white px-2 py-1 rounded text-[10px] font-bold hover:bg-green-700"
                        title="Pull from Sheets">‚Üì</button>
                    <button onclick="syncToGoogle()"
                        class="flex-1 bg-blue-600 text-white px-2 py-1 rounded text-[10px] font-bold hover:bg-blue-700"
                        title="Push to Sheets">‚Üë</button>
                    <button onclick="bidirectionalSync()"
                        class="flex-1 bg-purple-600 text-white px-2 py-1 rounded text-[10px] font-bold hover:bg-purple-700"
                        title="Smart Merge">‚ü≥</button>
                </div>
            </div>
            <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100">
                <h3 class="text-slate-400 text-[10px] font-bold uppercase mb-1">Details</h3>
                <div id="syncStatus" class="text-xs font-bold text-slate-400 italic mb-2">Local Storage Mode</div>
                <div id="sheetNameDisplay" class="text-[11px] font-semibold text-slate-600 truncate">No sheet selected
                </div>
            </div>
        </section>

        <!-- Tracker Grid -->
        <section class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="px-4 py-3 bg-slate-50 border-b border-slate-200 flex justify-between items-center">
                <h2 class="font-bold text-slate-700 text-sm">Monthly Log</h2>
                <button onclick="clearAllLogs()"
                    class="bg-red-500 text-white px-3 py-1.5 rounded-lg text-[10px] font-bold hover:bg-red-600 transition">
                    Clear All Logs
                </button>
            </div>
            <div class="overflow-x-auto">
                <div id="habitGrid" class="habit-grid select-none"></div>
            </div>
        </section>

        <!-- Charts -->
        <section class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-white p-5 rounded-xl border border-slate-200">
                <h3 class="font-bold text-slate-800 text-sm mb-4">üìà Daily XP Trend</h3>
                <div class="chart-wrapper"><canvas id="performanceChart"></canvas></div>
            </div>
            <div class="bg-white p-5 rounded-xl border border-slate-200">
                <h3 class="font-bold text-slate-800 text-sm mb-4">üìä Consistency Bars</h3>
                <div class="chart-wrapper"><canvas id="habitRadarChart"></canvas></div>
            </div>
            <div class="bg-white p-5 rounded-xl border border-slate-200">
                <h3 class="font-bold text-slate-800 text-sm mb-4">üéØ Habit Completion Rate</h3>
                <div class="chart-wrapper"><canvas id="completionChart"></canvas></div>
            </div>
            <div class="bg-white p-5 rounded-xl border border-slate-200">
                <h3 class="font-bold text-slate-800 text-sm mb-4">üí∞ XP Distribution</h3>
                <div class="chart-wrapper"><canvas id="xpDistributionChart"></canvas></div>
            </div>
            <div class="bg-white p-5 rounded-xl border border-slate-200">
                <h3 class="font-bold text-slate-800 text-sm mb-4">üìÖ Weekly Progress</h3>
                <div class="chart-wrapper"><canvas id="weeklyChart"></canvas></div>
            </div>
            <div class="bg-white p-5 rounded-xl border border-slate-200">
                <h3 class="font-bold text-slate-800 text-sm mb-4">üî• Habit Streak Analysis</h3>
                <div class="chart-wrapper"><canvas id="streakChart"></canvas></div>
            </div>
        </section>
    </div>

    <!-- MODAL -->
    <div id="settingModal" class="modal">
        <div class="bg-white rounded-2xl p-6 max-w-md w-full mx-4 shadow-2xl overflow-y-auto max-h-[90vh]">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-slate-800">App Settings</h2>
                <button onclick="toggleAppSettingManager()" class="text-slate-400 hover:text-slate-600 p-2">‚úï</button>
            </div>
            <div class="flex items-center justify-between mb-2">
                <h3 class="text-[10px] font-bold text-slate-400 uppercase">Google Sheets Management</h3>
                <label class="inline-flex items-center cursor-pointer text-[10px] font-bold text-slate-500 uppercase gap-2">
                    <span>Enabled</span>
                    <input id="cloudSyncToggle" type="checkbox" class="sr-only">
                    <span class="toggle-track">
                        <span class="toggle-thumb"></span>
                    </span>
                </label>
            </div>
            <div id="googleSheetsManagementSection" class="space-y-4 mb-6 p-4 bg-slate-50 rounded-xl border border-slate-200">
                <div class="p-3 bg-blue-50 border border-blue-200 rounded-lg text-[11px] text-blue-800 mb-2">
                    <strong>Setup Instructions:</strong><br>
                    1. Go to <a href="https://console.cloud.google.com" target="_blank" class="underline">Google Cloud
                        Console</a><br>
                    2. Enable <strong>Google Sheets API</strong><br>
                    3. Create OAuth 2.0 Client ID credentials<br>
                    4. Add this URL to <strong>Authorized JavaScript origins</strong>:<br>
                    <code class="bg-white px-2 py-1 rounded text-[10px] block mt-1" id="currentOrigin"></code>
                </div>
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase">API Key</label>
                    <input id="apiKey" type="text"
                        class="w-full px-3 py-2 border rounded text-xs outline-none focus:ring-1"
                        placeholder="Enter Google API Key">
                </div>
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase">Client ID</label>
                    <input id="clientId" type="text"
                        class="w-full px-3 py-2 border rounded text-xs outline-none focus:ring-1"
                        placeholder="Enter Client ID">
                </div>
                <div class="p-3 bg-amber-50 border border-amber-200 rounded-lg text-[11px] text-amber-800">
                    <strong>üí° Tip:</strong> Use different spreadsheets for different months!<br>
                    The <strong>Active Sheet ID</strong> lets you quickly switch between them.
                </div>
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase">Spreadsheet ID</label>
                    <input id="sheetId" type="text" onchange="handleModalSheetIdChange()"
                        class="w-full px-3 py-2 border rounded text-xs outline-none focus:ring-1"
                        placeholder="Spreadsheet ID from URL">
                </div>
                <div class="flex gap-2">
                    <button id="authBtn" onclick="handleAuthClick()"
                        class="flex-1 bg-blue-600 text-white py-2 rounded text-xs font-bold hover:bg-blue-700">Connect &
                        Sync</button>
                    <button onclick="handleSignoutClick()"
                        class="bg-slate-200 text-slate-700 px-4 py-2 rounded text-xs font-bold">Sign Out</button>
                </div>
                <div class="mt-3 p-3 bg-green-50 border border-green-200 rounded-lg">
                    <p class="text-[10px] font-bold text-green-800 mb-2">Cloud Sync Actions:</p>
                    <div class="flex gap-2">
                        <button onclick="syncFromGoogle()"
                            class="flex-1 bg-green-600 text-white py-2 rounded text-xs font-bold hover:bg-green-700">‚Üì
                            Pull from Sheets</button>
                        <button onclick="syncToGoogle()"
                            class="flex-1 bg-blue-600 text-white py-2 rounded text-xs font-bold hover:bg-blue-700">‚Üë
                            Push to Sheets</button>
                    </div>
                    <button onclick="bidirectionalSync()"
                        class="w-full mt-2 bg-purple-600 text-white py-2 rounded text-xs font-bold hover:bg-purple-700">‚ü≥
                        Smart Merge Sync</button>
                </div>
            </div>
            <br>
            <div class="pt-4 border-t border-slate-100 space-y-2">
                <h3 class="text-[10px] font-bold text-slate-400 uppercase mb-2">Export options</h3>
                <button onclick="exportCSV()"
                    class="w-full bg-slate-700 text-white py-2 rounded text-xs font-bold hover:bg-slate-800">
                    Export CSV
                </button>
                <button onclick="exportJSON()"
                    class="w-full bg-slate-600 text-white py-2 rounded text-xs font-bold hover:bg-slate-700">
                    Export JSON
                </button>
                <h3 class="text-[10px] font-bold text-slate-400 uppercase mb-2">Import options</h3>
                <button onclick="triggerImport('csv')"
                    class="w-full bg-slate-500 text-white py-2 rounded text-xs font-bold hover:bg-slate-600">
                    Import CSV
                </button>
                <button onclick="triggerImport('json')"
                    class="w-full bg-slate-500 text-white py-2 rounded text-xs font-bold hover:bg-slate-600">
                    Import JSON
                </button>
                <input id="importCSVInput" type="file" accept=".csv,text/csv" class="hidden"
                    onchange="handleCSVImport(event)">
                <input id="importJSONInput" type="file" accept=".json,application/json" class="hidden"
                    onchange="handleJSONImport(event)">
            </div>

            <div class="pt-4 border-t border-slate-100 space-y-3">
                <h3 class="text-[10px] font-bold text-slate-400 uppercase">Daily Reminder</h3>
                <p class="text-[11px] text-slate-500">Pick a time to receive a native browser reminder to review your habits. Requires notification permission.</p>
                <div class="flex flex-col sm:flex-row sm:items-center gap-2">
                    <input id="reminderTime" type="time" class="flex-1 px-3 py-2 border rounded text-xs outline-none focus:ring-1"
                        onchange="handleReminderTimeChange(this.value)">
                    <button onclick="enableHabitNotifications()"
                        class="bg-blue-600 text-white px-3 py-2 rounded text-xs font-bold hover:bg-blue-700">Enable Notifications</button>
                    <button onclick="clearReminderSetting()"
                        class="bg-slate-200 text-slate-700 px-3 py-2 rounded text-xs font-bold">Clear</button>
                </div>
                <p id="reminderStatus" class="text-[11px] font-semibold text-slate-500">Notifications inactive.</p>
            </div>

        </div>
    </div>

    <div id="habitModal" class="modal">
        <div class="bg-white rounded-2xl p-6 max-w-md w-full mx-4 shadow-2xl overflow-y-auto max-h-[90vh]">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-slate-800">App Settings</h2>
                <button onclick="toggleHabitManager()" class="text-slate-400 hover:text-slate-600 p-2">‚úï</button>
            </div>
            <div class="pt-4 border-t border-slate-100">
                <h3 class="text-[10px] font-bold text-slate-400 uppercase mb-2">Habit Management</h3>
                <div class="p-3 bg-amber-50 border border-amber-200 rounded-lg text-[11px] text-amber-800">
                    <strong>‚úèÔ∏è Instructions:</strong> <br>
                    - Add `~` before a habit name to mark it as a vice.<br>
                    - Completed habit will gain 15xp. <br>
                    - Vices will deduct 15 XP.
                    <br>
                </div>
                <br>
                <div id="habitList" class="space-y-2 mb-4"></div>
                <div class="space-y-2">
                    <input id="newHabitName" type="text" placeholder="Habit name"
                        class="w-full px-3 py-2 border rounded-lg text-sm outline-none">
                    <button onclick="addHabit()"
                        class="w-full bg-slate-800 text-white py-2 rounded-lg text-sm font-bold">Add Habit</button>
                </div>
            </div>

        </div>
    </div>

    <script>
        // Settings State
        let API_KEY = localStorage.getItem('g_api_key') || '';
        let CLIENT_ID = localStorage.getItem('g_client_id') || '';
        let SPREADSHEET_ID = localStorage.getItem('g_sheet_id') || '';

        const DISCOVERY_DOC = 'https://sheets.googleapis.com/$discovery/rest?version=v4';
        const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';

        let tokenClient;
        let gapiInited = false;
        let gsiInited = false;
        let tokenRefreshTimeout = null;
        let tokenClientOptions = {};
        let cloudSyncEnabled = localStorage.getItem('cloud_sync_enabled') === 'true';

        function isLikelyApiKey(key) {
            if (!key || typeof key !== 'string') {
                return false;
            }
            if (key.startsWith('GOCSPX')) {
                return false;
            }
            return /^AIza[0-9A-Za-z_\-]{20,}$/.test(key.trim());
        }

        // Habit App Logic - Default to current month
        let currentYear = new Date().getFullYear();
        let currentMonth = new Date().getMonth();
        let habits = JSON.parse(localStorage.getItem('habit_template')) || [
            { id: '1', name: 'Exercise', type: 'health', xp: 15 },
            { id: '2', name: 'Drink Water', type: 'health', xp: 15 }
        ];
        let logs = JSON.parse(localStorage.getItem('habit_logs')) || {};
        let reminderTimeSetting = localStorage.getItem('habit_reminder_time') || '';
        let reminderCheckInterval = null;
        let perfChart, radarChart, completionChart, xpDistributionChart, weeklyChart, streakChart;

        function getDaysInMonth(year, month) { return new Date(year, month + 1, 0).getDate(); }
        function getMonthKey() { return `${currentYear}-${currentMonth}`; }
        function normalizeHabitName(raw) {
            if (!raw) {
                return '';
            }
            return raw.replace(/^~/, '').trim().toLowerCase();
        }

        function supportsNotifications() {
            return 'Notification' in window;
        }

        // --- GOOGLE API INITIALIZATION ---

        // Load GAPI and GIS
        function gapiLoaded() { gapi.load('client', intializeGapiClient); }

        async function intializeGapiClient() {
            if (!cloudSyncEnabled) {
                return;
            }
            if (!API_KEY || !isLikelyApiKey(API_KEY)) {
                updateApiStatus('Invalid API Key Format', 'red');
                return;
            }
            try {
                await gapi.client.init({
                    apiKey: API_KEY,
                    discoveryDocs: [DISCOVERY_DOC],
                });
                gapiInited = true;

                ensureTokenClient();

                const savedToken = localStorage.getItem('g_access_token');
                const rawExpiry = localStorage.getItem('g_token_expiry');
                const expiryMs = rawExpiry ? parseInt(rawExpiry, 10) : 0;

                if (savedToken && expiryMs && Date.now() < expiryMs) {
                    gapi.client.setToken({ access_token: savedToken });
                    console.log("Restored saved token");
                    const secondsRemaining = Math.max(Math.floor((expiryMs - Date.now()) / 1000), 60);
                    scheduleTokenRefresh(secondsRemaining);
                    if (SPREADSHEET_ID) {
                        setTimeout(() => fetchSheetName(), 500);
                    }
                    const statusEl = document.getElementById('syncStatus');
                    if (statusEl) {
                        statusEl.innerText = "Cloud Mode (Auto-restored)";
                    }
                } else if (savedToken && CLIENT_ID) {
                    requestToken({ promptOverride: '', silent: true });
                }

                updateApiStatus();
            } catch (err) {
                console.error("GAPI Init error:", err);
                clearScheduledRefresh();
                if (err.result?.error?.code === 400) {
                    updateApiStatus("Invalid API Key", "red");
                } else {
                    updateApiStatus("API Init Failed", "red");
                }
                gapiInited = false;
            }
        }

        function clearScheduledRefresh() {
            if (tokenRefreshTimeout) {
                clearTimeout(tokenRefreshTimeout);
                tokenRefreshTimeout = null;
            }
        }

        function ensureTokenClient() {
            if (tokenClient || !CLIENT_ID) {
                return tokenClient;
            }
            try {
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID,
                    scope: SCOPES,
                    callback: (resp) => {
                        handleTokenResponse(resp);
                    },
                });
            } catch (err) {
                console.error("GIS Init error:", err);
                tokenClient = null;
            }
            return tokenClient;
        }

        function scheduleTokenRefresh(expiresInSeconds) {
            if (!cloudSyncEnabled) {
                return;
            }
            const seconds = Number(expiresInSeconds);
            if (!Number.isFinite(seconds) || seconds <= 0) {
                return;
            }
            clearScheduledRefresh();
            const refreshLead = Math.max(seconds - 300, 60); // refresh 5 minutes early
            tokenRefreshTimeout = setTimeout(() => {
                requestToken({ promptOverride: '', silent: true });
            }, refreshLead * 1000);
            localStorage.setItem('g_token_expiry', (Date.now() + seconds * 1000).toString());
        }

        function requestToken(options = {}) {
            if (!cloudSyncEnabled) {
                return;
            }
            if (!CLIENT_ID) {
                if (!options.silent) {
                    alert("Client ID is required before authenticating with Google.");
                }
                return;
            }
            ensureTokenClient();
            if (!tokenClient) {
                if (!options.silent) {
                    alert("Authentication error. Check console for details.");
                }
                return;
            }

            tokenClientOptions = {
                runSync: false,
                showAlert: false,
                closeModal: false,
                silent: false,
                ...options
            };

            const hasToken = Boolean(gapi.client?.getToken());
            const prompt = options.promptOverride !== undefined ? options.promptOverride : (hasToken ? '' : 'consent');

            try {
                tokenClient.requestAccessToken({ prompt });
            } catch (err) {
                console.error("Token request error:", err);
                if (!tokenClientOptions.silent) {
                    alert("Authentication error. Check console for details.");
                }
            }
        }

        async function handleTokenResponse(resp) {
            const options = tokenClientOptions || {};
            tokenClientOptions = {};

            if (resp.error !== undefined) {
                console.error("OAuth Error:", resp);
                updateApiStatus("Auth Failed: " + resp.error, "red");
                if (!options.silent) {
                    alert("Authentication failed: " + resp.error + "\n\nMake sure you've added this URL to Authorized JavaScript origins:\n" + window.location.origin);
                }
                return;
            }

            if (resp.access_token) {
                gapi.client.setToken({ access_token: resp.access_token });
                localStorage.setItem('g_access_token', resp.access_token);
                const expiresIn = Number(resp.expires_in) || 3600;
                scheduleTokenRefresh(expiresIn);
            }

            updateApiStatus();

            if (options.runSync) {
                try {
                    await syncToGoogle();
                    await syncFromGoogle();
                } catch (err) {
                    console.error("Post-auth sync error:", err);
                    const statusEl = document.getElementById('syncStatus');
                    if (statusEl) {
                        statusEl.innerText = "Cloud Sync Error";
                    }
                }
            }

            if (options.closeModal) {
                toggleAppSettingManager();
            }

            if (options.showAlert) {
                alert("Successfully connected to Google Sheets!");
            }
        }

        function updateApiStatus(overrideMsg, color) {
            const display = document.getElementById('apiStatusDisplay');
            if (overrideMsg) {
                display.innerText = overrideMsg;
                display.className = `text-sm font-bold text-${color}-500`;
                return;
            }

            if (!cloudSyncEnabled) {
                display.innerText = "Cloud Sync Disabled";
                display.className = "text-sm font-bold text-slate-400";
                return;
            }

            const token = gapi.client?.getToken();
            if (token) {
                display.innerText = "Connected to Google";
                display.className = "text-sm font-bold text-green-600";
            } else if (API_KEY && CLIENT_ID) {
                display.innerText = "Ready to Authenticate";
                display.className = "text-sm font-bold text-blue-500";
            } else {
                display.innerText = "Settings Incomplete";
                display.className = "text-sm font-bold text-slate-400";
            }
        }

        function setCloudSyncVisibility(enabled) {
            const managementSection = document.getElementById('googleSheetsManagementSection');
            const syncCard = document.getElementById('sheetsSyncCard');
            cloudSyncEnabled = enabled;
            if (managementSection) {
                managementSection.classList.toggle('hidden', !enabled);
            }
            if (syncCard) {
                syncCard.classList.toggle('hidden', !enabled);
            }
            localStorage.setItem('cloud_sync_enabled', enabled ? 'true' : 'false');

            if (!enabled) {
                clearScheduledRefresh();
                updateApiStatus("Cloud Sync Disabled", "slate");
                return;
            }

            if (!API_KEY || !isLikelyApiKey(API_KEY)) {
                updateApiStatus('Invalid API Key Format', 'red');
                return;
            }

            updateApiStatus();

            if (!gapiInited) {
                if (typeof gapi !== 'undefined') {
                    gapiLoaded();
                }
                return;
            }

            ensureTokenClient();

            const rawExpiry = localStorage.getItem('g_token_expiry');
            const expiryMs = rawExpiry ? parseInt(rawExpiry, 10) : 0;

            if (gapi.client?.getToken()) {
                if (expiryMs && Date.now() < expiryMs) {
                    const secondsRemaining = Math.max(Math.floor((expiryMs - Date.now()) / 1000), 60);
                    scheduleTokenRefresh(secondsRemaining);
                }
            } else if (localStorage.getItem('g_access_token')) {
                requestToken({ promptOverride: '', silent: true });
            }
        }

        function formatReminderLabel(timeStr) {
            if (!timeStr || !timeStr.includes(':')) {
                return '';
            }
            const [hourStr, minuteStr] = timeStr.split(':');
            const hour = parseInt(hourStr, 10);
            const minute = parseInt(minuteStr, 10);
            if (Number.isNaN(hour) || Number.isNaN(minute)) {
                return '';
            }
            const fallbackDate = new Date();
            fallbackDate.setHours(hour, minute, 0, 0);
            try {
                return new Intl.DateTimeFormat([], { hour: 'numeric', minute: '2-digit' }).format(fallbackDate);
            } catch (err) {
                return `${hourStr}:${minuteStr}`;
            }
        }

        function updateReminderStatus(message, tone = 'neutral') {
            const statusEl = document.getElementById('reminderStatus');
            if (!statusEl) {
                return;
            }
            const toneClass = tone === 'green'
                ? 'text-green-600'
                : tone === 'red'
                    ? 'text-red-500'
                    : 'text-slate-500';
            statusEl.className = `text-[11px] font-semibold ${toneClass}`;
            statusEl.innerText = message;
        }

        function handleReminderTimeChange(value) {
            reminderTimeSetting = value ? value.trim() : '';
            if (!reminderTimeSetting) {
                localStorage.removeItem('habit_reminder_time');
                updateReminderStatus('Notifications inactive.', 'neutral');
                stopReminderWatcher();
                return;
            }
            localStorage.setItem('habit_reminder_time', reminderTimeSetting);
            const label = formatReminderLabel(reminderTimeSetting) || reminderTimeSetting;
            const permissionGranted = supportsNotifications() && Notification.permission === 'granted';
            updateReminderStatus(`Reminder set for ${label}.`, permissionGranted ? 'green' : 'neutral');
            startReminderWatcher();
        }

        function enableHabitNotifications() {
            if (!supportsNotifications()) {
                updateReminderStatus('Notifications are not supported in this browser.', 'red');
                alert('Notifications are not supported in this browser. Please try another device or browser.');
                return;
            }
            Notification.requestPermission().then(permission => {
                if (permission === 'granted') {
                    const label = formatReminderLabel(reminderTimeSetting);
                    updateReminderStatus(label ? `Reminder set for ${label}.` : 'Notifications enabled. Set a reminder time to activate daily alerts.', label ? 'green' : 'neutral');
                    startReminderWatcher();
                    checkDailyReminder();
                } else if (permission === 'denied') {
                    updateReminderStatus('Notifications blocked. Enable them in browser settings to receive reminders.', 'red');
                } else {
                    updateReminderStatus('Notifications pending. Please accept the permission prompt.', 'neutral');
                }
            }).catch(err => {
                console.error('Notification permission error:', err);
                updateReminderStatus('Failed to enable notifications. Check console for details.', 'red');
            });
        }

        function clearReminderSetting() {
            reminderTimeSetting = '';
            localStorage.removeItem('habit_reminder_time');
            localStorage.removeItem('habit_reminder_last');
            const input = document.getElementById('reminderTime');
            if (input) {
                input.value = '';
            }
            stopReminderWatcher();
            updateReminderStatus('Notifications inactive.', 'neutral');
        }

        function startReminderWatcher() {
            stopReminderWatcher();
            if (!reminderTimeSetting) {
                return;
            }
            if (!supportsNotifications()) {
                updateReminderStatus('Notifications are not supported in this browser.', 'red');
                return;
            }
            if (Notification.permission !== 'granted') {
                updateReminderStatus('Grant notification permission to enable reminders.', 'neutral');
                return;
            }
            checkDailyReminder();
            reminderCheckInterval = setInterval(checkDailyReminder, 60 * 1000);
        }

        function stopReminderWatcher() {
            if (reminderCheckInterval) {
                clearInterval(reminderCheckInterval);
                reminderCheckInterval = null;
            }
        }

        function checkDailyReminder() {
            if (!reminderTimeSetting || Notification.permission !== 'granted') {
                return;
            }
            const [hourStr, minuteStr] = reminderTimeSetting.split(':');
            const hour = parseInt(hourStr, 10);
            const minute = parseInt(minuteStr, 10);
            if (Number.isNaN(hour) || Number.isNaN(minute)) {
                return;
            }
            const now = new Date();
            const currentTotalMinutes = now.getHours() * 60 + now.getMinutes();
            const reminderTotalMinutes = hour * 60 + minute;
            const todayKey = now.toISOString().slice(0, 10);
            const lastSentDay = localStorage.getItem('habit_reminder_last');

            if (currentTotalMinutes >= reminderTotalMinutes && lastSentDay !== todayKey) {
                try {
                    new Notification('Habit Tracker Reminder', {
                        body: 'Time to review and update your habits for today.',
                        icon: 'favicon.ico',
                        tag: 'habit-tracker-daily-reminder'
                    });
                    localStorage.setItem('habit_reminder_last', todayKey);
                    const label = formatReminderLabel(reminderTimeSetting) || reminderTimeSetting;
                    updateReminderStatus(`Reminder sent for ${label}.`, 'green');
                } catch (err) {
                    console.error('Notification error:', err);
                    updateReminderStatus('Failed to show notification. Check browser console for details.', 'red');
                }
            } else if (lastSentDay === todayKey) {
                const label = formatReminderLabel(reminderTimeSetting) || reminderTimeSetting;
                updateReminderStatus(`Reminder sent for ${label}.`, 'green');
            }
        }

        async function handleAuthClick() {
            // 1. Grab values from inputs
            API_KEY = document.getElementById('apiKey').value.trim();
            CLIENT_ID = document.getElementById('clientId').value.trim();

            if (!API_KEY || !CLIENT_ID) {
                alert("Please fill in API Key and Client ID.");
                return;
            }

            if (!isLikelyApiKey(API_KEY)) {
                updateApiStatus('Invalid API Key Format', 'red');
                alert("The API Key you entered does not look valid. Please use the Web API Key from Google Cloud Console (typically starts with 'AIza').");
                return;
            }

            // 2. Persist locally
            localStorage.setItem('g_api_key', API_KEY);
            localStorage.setItem('g_client_id', CLIENT_ID);

            // 3. Initialize GAPI if not done
            if (!gapiInited) {
                await intializeGapiClient();
            }

            // 4. Initialize GIS (Token Client)
            try {
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID,
                    scope: SCOPES,
                    callback: async (resp) => {
                        if (resp.error !== undefined) {
                            console.error("OAuth Error:", resp);
                            updateApiStatus("Auth Failed: " + resp.error, "red");
                            alert("Authentication failed: " + resp.error + "\n\nMake sure you've added this URL to Authorized JavaScript origins:\n" + window.location.origin);
                            return;
                        }

                        // Save token to localStorage (expires in 1 hour by default)
                        if (resp.access_token) {
                            localStorage.setItem('g_access_token', resp.access_token);
                            // Set expiry to 50 minutes from now (tokens usually last 1 hour)
                            localStorage.setItem('g_token_expiry', (Date.now() + 50 * 60 * 1000).toString());
                        }

                        updateApiStatus();
                        await syncToGoogle();
                        await syncFromGoogle();
                        alert("Successfully connected to Google Sheets!");
                        toggleAppSettingManager();
                    },
                });

                // Trigger token request
                if (gapi.client.getToken() === null) {
                    tokenClient.requestAccessToken({ prompt: 'consent' });
                } else {
                    tokenClient.requestAccessToken({ prompt: '' });
                }
            } catch (err) {
                console.error("GIS/Auth error:", err);
                updateApiStatus("Auth Error", "red");
                alert("Authentication error. Check console for details.");
            }
        }

        function handleSignoutClick() {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token);
                gapi.client.setToken('');

                // Clear saved tokens
                localStorage.removeItem('g_access_token');
                localStorage.removeItem('g_token_expiry');

                updateApiStatus();
                document.getElementById('syncStatus').innerText = "Local Storage Mode";
            }
        }

        async function syncToGoogle() {
            if (!SPREADSHEET_ID || !gapiInited || !gapi.client.sheets) {
                console.warn("Google API not ready");
                return;
            }
            const token = gapi.client.getToken();
            if (!token) {
                console.warn("Not authenticated");
                return;
            }

            const days = getDaysInMonth(currentYear, currentMonth);
            const monthKey = getMonthKey();
            const headerRow = ["Habit Name", ...Array.from({ length: days }, (_, i) => i + 1)];

            const rows = habits.map(h => {
                const row = [h.name];
                for (let d = 1; d <= days; d++) {
                    const isChecked = logs[`${monthKey}-${d}-${h.id}`];
                    row.push(isChecked ? "TRUE" : "FALSE");
                }
                return row;
            });

            const body = { values: [headerRow, ...rows] };
            try {
                await gapi.client.sheets.spreadsheets.values.clear({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'A1:ZZ1000',
                });
            } catch (clearErr) {
                console.warn("Sheet clear warning:", clearErr);
            }

            try {
                await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'A1',
                    valueInputOption: 'USER_ENTERED',
                    resource: body,
                });
                document.getElementById('syncStatus').innerText = "‚Üë Pushed: " + new Date().toLocaleTimeString();
                console.log("Data pushed to Google Sheets successfully");
            } catch (err) {
                console.error("Sync Error:", err);
                document.getElementById('syncStatus').innerText = "Cloud Sync Error";
                if (err.result?.error?.code === 400) {
                    alert("‚ö†Ô∏è API Key Issue\n\n" + err.result.error.message + "\n\nCheck your API key configuration in Google Cloud Console.");
                }
            }
        }

        async function syncFromGoogle() {
            if (!SPREADSHEET_ID || !gapiInited || !gapi.client.sheets) {
                console.warn("Google API not ready");
                return;
            }
            const token = gapi.client.getToken();
            if (!token) {
                console.warn("Not authenticated");
                return;
            }

            try {
                // Get spreadsheet metadata to fetch the sheet name
                const metadataResponse = await gapi.client.sheets.spreadsheets.get({
                    spreadsheetId: SPREADSHEET_ID
                });

                const sheetName = metadataResponse.result.properties.title;
                document.getElementById('sheetNameDisplay').innerText = sheetName;
                localStorage.setItem('g_sheet_name', sheetName);

                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'A1:ZZ100',
                });

                const rows = response.result.values;
                if (!rows || rows.length === 0) {
                    alert("No data found in the spreadsheet.");
                    return;
                }

                const headerRow = rows[0];
                const days = headerRow.length - 1; // First column is "Habit Name"
                const monthKey = getMonthKey();

                // Clear existing habits and rebuild from sheet
                const newHabits = [];
                const newLogs = {};

                for (let i = 1; i < rows.length; i++) {
                    const row = rows[i];
                    const habitName = row[0];
                    if (!habitName) continue;

                    // Check if habit name starts with ~ (vice)
                    const isVice = habitName.startsWith('~');
                    const cleanName = isVice ? habitName.substring(1) : habitName;

                    // Create or find habit
                    let habit = habits.find(h => h.name === habitName);
                    if (!habit) {
                        habit = {
                            id: Date.now().toString() + i,
                            name: habitName,
                            type: isVice ? 'vice' : 'health',
                            xp: isVice ? -15 : 15
                        };
                    }
                    newHabits.push(habit);

                    // Import logs for each day
                    for (let d = 1; d <= days; d++) {
                        const cellValue = row[d];
                        const logKey = `${monthKey}-${d}-${habit.id}`;
                        newLogs[logKey] = cellValue === "TRUE" || cellValue === true;
                    }
                }

                // Update app state
                habits = newHabits;
                logs = { ...logs, ...newLogs }; // Merge with existing logs from other months

                saveState();
                refreshUI();
                document.getElementById('syncStatus').innerText = "‚Üì Pulled: " + new Date().toLocaleTimeString();
                console.log("Data pulled from Google Sheets successfully");
            } catch (err) {
                console.error("Pull Error:", err);
                alert("Failed to pull from Google Sheets: " + err.message);
            }
        }

        async function bidirectionalSync() {
            if (!SPREADSHEET_ID || !gapiInited || !gapi.client.sheets) {
                console.warn("Google API not ready");
                return;
            }
            const token = gapi.client.getToken();
            if (!token) {
                console.warn("Not authenticated");
                return;
            }

            try {
                // First pull from Sheets
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'A1:ZZ100',
                });

                const rows = response.result.values;
                const monthKey = getMonthKey();

                if (rows && rows.length > 0) {
                    const headerRow = rows[0];
                    const days = headerRow.length - 1;

                    // Merge habits and logs
                    for (let i = 1; i < rows.length; i++) {
                        const row = rows[i];
                        const habitName = row[0];
                        if (!habitName) continue;

                        let habit = habits.find(h => h.name === habitName);
                        if (!habit) {
                            habit = { id: Date.now().toString() + i, name: habitName, type: 'health', xp: 15 };
                            habits.push(habit);
                        }

                        for (let d = 1; d <= days; d++) {
                            const cellValue = row[d];
                            const logKey = `${monthKey}-${d}-${habit.id}`;
                            // Only overwrite if sheet has TRUE and local is false
                            if (cellValue === "TRUE" || cellValue === true) {
                                logs[logKey] = true;
                            }
                        }
                    }
                }

                // Then push merged data back
                saveState();
                await syncToGoogle();
                refreshUI();
                document.getElementById('syncStatus').innerText = "‚ü≥ Synced: " + new Date().toLocaleTimeString();
                alert("Bidirectional sync complete!");
            } catch (err) {
                console.error("Bidirectional Sync Error:", err);
                alert("Sync failed: " + err.message);
            }
        }

        function exportCSV() {
            const days = getDaysInMonth(currentYear, currentMonth);
            const monthKey = getMonthKey();
            const headerRow = ['Habit Name', ...Array.from({ length: days }, (_, i) => i + 1)];
            const rows = habits.map(h => {
                const row = [h.name];
                for (let d = 1; d <= days; d++) {
                    const logKey = `${monthKey}-${d}-${h.id}`;
                    row.push(logs[logKey] ? 'Checked' : '');
                }
                return row;
            });
            const encode = value => `"${String(value).replace(/"/g, '""')}"`;
            const csvLines = [headerRow, ...rows].map(row => row.map(encode).join(','));
            const csvContent = csvLines.join('\n');
            const monthLabel = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `habit-tracker-${monthLabel}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            const statusEl = document.getElementById('syncStatus');
            if (statusEl) {
                statusEl.innerText = `Exported CSV: ${new Date().toLocaleTimeString()}`;
            }
        }

        function exportJSON() {
            const monthLabel = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;
            const storageSnapshot = {};
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                storageSnapshot[key] = localStorage.getItem(key);
            }
            const payload = {
                exportedAt: new Date().toISOString(),
                month: {
                    label: monthLabel,
                    year: currentYear,
                    monthIndex: currentMonth,
                    key: getMonthKey()
                },
                habits: habits.map(h => ({ ...h })),
                logs: { ...logs },
                storageSnapshot
            };
            const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `habit-tracker-${monthLabel}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            const statusEl = document.getElementById('syncStatus');
            if (statusEl) {
                statusEl.innerText = `Exported JSON: ${new Date().toLocaleTimeString()}`;
            }
        }


        function triggerImport(kind) {
            const input = document.getElementById(kind === 'csv' ? 'importCSVInput' : 'importJSONInput');
            if (input) {
                input.click();
            }
        }

        function parseCSV(text) {
            const rows = [];
            let field = '';
            let inQuotes = false;
            let row = [];
            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                if (char === '"') {
                    if (inQuotes && text[i + 1] === '"') {
                        field += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    row.push(field);
                    field = '';
                } else if ((char === '\n' || char === '\r') && !inQuotes) {
                    if (char === '\r' && text[i + 1] === '\n') i++;
                    row.push(field);
                    rows.push(row);
                    row = [];
                    field = '';
                } else {
                    field += char;
                }
            }
            row.push(field);
            rows.push(row);
            return rows.filter(r => !(r.length === 1 && r[0] === ''));
        }

        function handleCSVImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                try {
                    const rows = parseCSV(e.target.result);
                    if (!rows.length) {
                        alert('CSV file is empty.');
                        return;
                    }
                    const header = rows[0];
                    if (header.length < 2) {
                        alert('CSV should include at least one day column.');
                        return;
                    }
                    const days = header.length - 1;
                    const monthKey = getMonthKey();
                    const existingByName = {};
                    habits.forEach(h => { existingByName[h.name] = h; });
                    const updatedHabits = [];
                    const monthUpdates = {};
                    rows.slice(1).forEach((rawRow, index) => {
                        const row = [...rawRow];
                        while (row.length < header.length) {
                            row.push('');
                        }
                        const habitName = row[0] ? row[0].trim() : '';
                        if (!habitName) return;
                        const isVice = habitName.startsWith('~');
                        const base = existingByName[habitName];
                        const habit = base ? { ...base } : {
                            id: `import-${Date.now()}-${index}`,
                            name: habitName,
                            type: isVice ? 'vice' : 'health',
                            xp: isVice ? -15 : 15
                        };
                        if (isVice && habit.type !== 'vice') {
                            habit.type = 'vice';
                            habit.xp = habit.xp < 0 ? habit.xp : -Math.abs(habit.xp || 15);
                        } else if (!isVice && habit.type === 'vice') {
                            habit.type = 'health';
                            habit.xp = Math.abs(habit.xp || 15);
                        }
                        existingByName[habitName] = habit;
                        updatedHabits.push(habit);
                        for (let d = 1; d <= days; d++) {
                            const cell = String(row[d] ?? '').trim().toLowerCase();
                            const isChecked = cell === 'true' || cell === '1' || cell === 'yes' || cell === 'y' || cell === 'checked' || cell === '‚úì';
                            const logKey = `${monthKey}-${d}-${habit.id}`;
                            monthUpdates[logKey] = isChecked;
                        }
                    });
                    if (!updatedHabits.length) {
                        alert('No habits detected in CSV.');
                        return;
                    }
                    const newLogs = { ...logs };
                    Object.keys(newLogs).forEach(key => {
                        if (key.startsWith(`${monthKey}-`)) {
                            delete newLogs[key];
                        }
                    });
                    Object.entries(monthUpdates).forEach(([key, value]) => {
                        newLogs[key] = Boolean(value);
                    });
                    habits = updatedHabits;
                    logs = newLogs;
                    saveState();
                    refreshUI();
                    if (document.getElementById('settingModal')?.classList.contains('active')) {
                        renderHabitList();
                    }
                    const statusEl = document.getElementById('syncStatus');
                    if (statusEl) {
                        statusEl.innerText = `Imported CSV: ${new Date().toLocaleTimeString()}`;
                    }
                } catch (err) {
                    console.error('CSV import error:', err);
                    alert(`Failed to import CSV: ${err.message}`);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function handleJSONImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                try {
                    const payload = JSON.parse(e.target.result);
                    if (!payload || !Array.isArray(payload.habits) || typeof payload.logs !== 'object') {
                        alert('JSON file is missing required fields.');
                        return;
                    }
                    if (payload.month) {
                        if (Number.isInteger(payload.month.year)) {
                            currentYear = payload.month.year;
                        }
                        if (Number.isInteger(payload.month.monthIndex) && payload.month.monthIndex >= 0 && payload.month.monthIndex <= 11) {
                            currentMonth = payload.month.monthIndex;
                        }
                    }
                    habits = payload.habits.map((h, index) => {
                        const isVice = h.type === 'vice' || (h.name && h.name.startsWith('~'));
                        const baseXP = typeof h.xp === 'number' ? h.xp : 15;
                        return {
                            id: h.id || `import-${Date.now()}-${index}`,
                            name: h.name || `Habit ${index + 1}`,
                            type: isVice ? 'vice' : 'health',
                            xp: isVice ? (baseXP < 0 ? baseXP : -Math.abs(baseXP)) : Math.abs(baseXP)
                        };
                    }).filter(h => h.name);
                    logs = { ...(payload.logs || {}) };
                    if (payload.storageSnapshot && typeof payload.storageSnapshot === 'object') {
                        Object.entries(payload.storageSnapshot).forEach(([key, value]) => {
                            if (typeof value === 'string') {
                                localStorage.setItem(key, value);
                            }
                        });
                        API_KEY = localStorage.getItem('g_api_key') || '';
                        CLIENT_ID = localStorage.getItem('g_client_id') || '';
                        SPREADSHEET_ID = localStorage.getItem('g_sheet_id') || '';
                        initMonthSelector();
                    }
                    saveState();
                    refreshUI();
                    if (document.getElementById('settingModal')?.classList.contains('active')) {
                        renderHabitList();
                    }
                    updateApiStatus();
                    if (SPREADSHEET_ID && gapiInited && gapi.client?.getToken()) {
                        fetchSheetName();
                    }
                    const statusEl = document.getElementById('syncStatus');
                    if (statusEl) {
                        statusEl.innerText = `Imported JSON: ${new Date().toLocaleTimeString()}`;
                    }
                } catch (err) {
                    console.error('JSON import error:', err);
                    alert(`Failed to import JSON: ${err.message}`);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        // --- APP LOGIC ---

        function saveState() {
            localStorage.setItem('habit_template', JSON.stringify(habits));
            localStorage.setItem('habit_logs', JSON.stringify(logs));
            // Auto-sync to Google if authenticated
            const token = gapi.client?.getToken();
            if (gapiInited && token) {
                syncToGoogle().catch(err => console.warn("Auto-sync failed:", err));
            }
        }

        function initGrid() {
            const grid = document.getElementById('habitGrid');
            const days = getDaysInMonth(currentYear, currentMonth);
            const monthKey = getMonthKey();
            document.documentElement.style.setProperty('--days-cols', days);
            grid.innerHTML = '';

            const corner = document.createElement('div');
            corner.className = 'sticky-col cell font-bold text-[9px] bg-slate-50 text-slate-400';
            corner.innerText = 'HABIT';
            grid.appendChild(corner);

            for (let i = 1; i <= days; i++) {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'cell font-bold text-[9px] text-slate-400 border-b-2';
                dayHeader.innerText = i;
                grid.appendChild(dayHeader);
            }

            habits.forEach(habit => {
                const rowLabel = document.createElement('div');
                rowLabel.className = 'sticky-col cell px-3 justify-start font-semibold text-[11px] text-slate-700 truncate';
                // Display name without ~ prefix
                const displayName = habit.name.startsWith('~') ? habit.name.substring(1) : habit.name;
                rowLabel.innerText = displayName;
                grid.appendChild(rowLabel);

                for (let day = 1; day <= days; day++) {
                    const logKey = `${monthKey}-${day}-${habit.id}`;
                    const isChecked = logs[logKey] || false;
                    const cell = document.createElement('div');
                    cell.className = `cell cell-check habit-${isChecked} ${habit.type === 'vice' ? 'habit-vice' : ''}`;

                    if (habit.type === 'vice') {
                        cell.innerHTML = isChecked ? '‚úì' : '';
                    } else {
                        cell.innerHTML = isChecked ? '‚úì' : '';
                    }

                    cell.onclick = () => {
                        logs[logKey] = !isChecked;
                        saveState();
                        refreshUI();
                    };
                    grid.appendChild(cell);
                }
            });
        }

        function updateStats() {
            const days = getDaysInMonth(currentYear, currentMonth);
            const monthKey = getMonthKey();
            let totalXP = 0;
            let dailyXP = new Array(days).fill(0);
            let habitCounts = {};
            let checkedCells = 0;
            // Only count positive XP habits for total cells
            const positiveHabits = habits.filter(h => h.xp > 0).length;
            let totalCells = positiveHabits * days;

            habits.forEach(h => habitCounts[h.id] = 0);

            for (let d = 1; d <= days; d++) {
                habits.forEach(h => {
                    if (logs[`${monthKey}-${d}-${h.id}`]) {
                        // Add XP (can be negative for vices)
                        totalXP += h.xp;
                        dailyXP[d - 1] += h.xp;
                        habitCounts[h.id]++;
                        // Only count positive XP habits for completion rate
                        if (h.xp > 0) {
                            checkedCells++;
                        }
                    }
                });
            }

            document.getElementById('totalXP').innerText = totalXP.toLocaleString();
            const rate = totalCells > 0 ? Math.round((checkedCells / totalCells) * 100) : 0;
            document.getElementById('completionRate').innerText = `${rate}%`;

            let bestName = "None";
            let maxCount = -1;
            habits.forEach(h => {
                if (habitCounts[h.id] > maxCount) {
                    maxCount = habitCounts[h.id];
                    // Display name without ~ prefix
                    const displayName = h.name.startsWith('~') ? h.name.substring(1) : h.name;
                    bestName = displayName;
                }
            });
            document.getElementById('bestHabit').innerText = maxCount > 0 ? bestName : "Keep going!";

            updateCharts(dailyXP, habitCounts);
        }

        function updateCharts(dailyXP, habitCounts) {
            const ctx1 = document.getElementById('performanceChart').getContext('2d');
            const ctx2 = document.getElementById('habitRadarChart').getContext('2d');
            const ctx3 = document.getElementById('completionChart').getContext('2d');
            const ctx4 = document.getElementById('xpDistributionChart').getContext('2d');
            const ctx5 = document.getElementById('weeklyChart').getContext('2d');
            const ctx6 = document.getElementById('streakChart').getContext('2d');
            const days = getDaysInMonth(currentYear, currentMonth);
            const monthKey = getMonthKey();

            if (perfChart) perfChart.destroy();
            if (radarChart) radarChart.destroy();
            if (completionChart) completionChart.destroy();
            if (xpDistributionChart) xpDistributionChart.destroy();
            if (weeklyChart) weeklyChart.destroy();
            if (streakChart) streakChart.destroy();

            // üìà Daily XP Trend
            perfChart = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: Array.from({ length: days }, (_, i) => i + 1),
                    datasets: [{
                        label: 'Daily XP',
                        data: dailyXP,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59,130,246,0.12)',
                        fill: true,
                        tension: 0.35,
                        pointRadius: 3,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true } }
                }
            });

            // üìä Consistency Bars
            radarChart = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: habits.map(h => h.name.startsWith('~') ? h.name.substring(1) : h.name),
                    datasets: [{
                        data: habits.map(h => habitCounts[h.id]),
                        backgroundColor: habits.map(h => h.type === 'vice' ? '#ef4444' : '#22c55e'),
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
                }
            });

            // üéØ Habit Completion Rate
            const completionRates = habits.map(h => ({
                name: h.name.startsWith('~') ? h.name.substring(1) : h.name,
                rate: days ? (habitCounts[h.id] / days) * 100 : 0
            }));
            completionChart = new Chart(ctx3, {
                type: 'doughnut',
                data: {
                    labels: completionRates.map(h => h.name),
                    datasets: [{
                        data: completionRates.map(h => h.rate),
                        backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#14b8a6', '#f97316'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { boxWidth: 12, font: { size: 10 }, padding: 8 }
                        },
                        tooltip: {
                            callbacks: {
                                label: ctx => `${ctx.label}: ${ctx.parsed.toFixed(1)}%`
                            }
                        }
                    }
                }
            });

            // üí∞ XP Distribution
            const xpByHabit = habits.map(h => ({
                name: h.name.startsWith('~') ? h.name.substring(1) : h.name,
                xp: habitCounts[h.id] * h.xp,
                type: h.type
            }));
            xpDistributionChart = new Chart(ctx4, {
                type: 'bar',
                data: {
                    labels: xpByHabit.map(h => h.name),
                    datasets: [{
                        data: xpByHabit.map(h => h.xp),
                        backgroundColor: xpByHabit.map(h => h.type === 'vice' ? '#ef4444' : '#10b981'),
                        borderRadius: 6
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { x: { beginAtZero: true } }
                }
            });

            // üìÖ Weekly Progress
            const weeks = Math.ceil(days / 7);
            const weeklyXP = new Array(weeks).fill(0);
            for (let d = 1; d <= days; d++) {
                const weekIndex = Math.floor((d - 1) / 7);
                habits.forEach(h => {
                    if (logs[`${monthKey}-${d}-${h.id}`]) weeklyXP[weekIndex] += h.xp;
                });
            }
            weeklyChart = new Chart(ctx5, {
                type: 'bar',
                data: {
                    labels: Array.from({ length: weeks }, (_, i) => `Week ${i + 1}`),
                    datasets: [{
                        data: weeklyXP,
                        backgroundColor: '#8b5cf6',
                        borderRadius: 8,
                        barThickness: 40
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true } }
                }
            });

            // üî• Habit Streak Analysis
            const streaks = habits.map(h => {
                let currentStreak = 0, maxStreak = 0, rolling = 0;
                for (let d = 1; d <= days; d++) {
                    if (logs[`${monthKey}-${d}-${h.id}`]) {
                        rolling++;
                        maxStreak = Math.max(maxStreak, rolling);
                    } else {
                        rolling = 0;
                    }
                }
                for (let d = Math.min(new Date().getDate(), days); d >= 1; d--) {
                    if (logs[`${monthKey}-${d}-${h.id}`]) currentStreak++;
                    else break;
                }
                return {
                    name: h.name.startsWith('~') ? h.name.substring(1) : h.name,
                    current: currentStreak,
                    max: maxStreak
                };
            });
            streakChart = new Chart(ctx6, {
                type: 'bar',
                data: {
                    labels: streaks.map(s => s.name),
                    datasets: [
                        { label: 'Current Streak üî•', data: streaks.map(s => s.current), backgroundColor: '#f59e0b', borderRadius: 4 },
                        { label: 'Max Streak üèÜ', data: streaks.map(s => s.max), backgroundColor: '#3b82f6', borderRadius: 4 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'top', labels: { boxWidth: 12, font: { size: 11 } } } },
                    scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
                }
            });
        }

        function refreshUI() { initGrid(); updateStats(); }

        function toggleAppSettingManager() {
            const modal = document.getElementById('settingModal');
            modal.classList.toggle('active');
            if (modal.classList.contains('active')) {
                renderHabitList();
            }
        }

        function toggleHabitManager() {
            const modal = document.getElementById('habitModal');
            modal.classList.toggle('active');
            if (modal.classList.contains('active')) {
                renderHabitList();
            }
        }

        function renderHabitList() {
            const list = document.getElementById('habitList');
            list.innerHTML = habits.map(h => {
                const displayName = h.name.startsWith('~') ? h.name.substring(1) : h.name;
                const typeIndicator = h.type === 'vice' ? '<span class="text-red-500 text-[10px]">(Vice)</span>' : '';
                return `
                    <div class="flex justify-between items-center p-2 bg-slate-50 rounded-lg border border-slate-100">
                        <p class="font-bold text-slate-700 text-[11px] truncate">${displayName} ${typeIndicator}</p>
                        <button onclick="removeHabit('${h.id}')" class="text-red-400 hover:text-red-600 px-2 font-bold">‚úï</button>
                    </div>
                `;
            }).join('');
        }

        function addHabit() {
            const name = document.getElementById('newHabitName').value.trim();
            if (name) {
                // Check if habit name starts with ~ (vice)
                const isVice = name.startsWith('~');
                const normalizedNewName = normalizeHabitName(name);
                if (!normalizedNewName) {
                    alert('Please enter a habit name.');
                    return;
                }
                const hasDuplicate = habits.some(h => normalizeHabitName(h.name) === normalizedNewName);
                if (hasDuplicate) {
                    alert('You already have a habit with that name.');
                    return;
                }
                habits.push({
                    id: Date.now().toString(),
                    name: name,
                    type: isVice ? 'vice' : 'health',
                    xp: isVice ? -15 : 15
                });
                document.getElementById('newHabitName').value = '';
                saveState();
                refreshUI();
                renderHabitList();
            }
        }

        function removeHabit(id) {
            const habitToRemove = habits.find(h => h.id === id);
            if (!habitToRemove) {
                return;
            }
            habits = habits.filter(h => h.id !== id);
            Object.keys(logs).forEach(key => {
                if (key.endsWith(`-${id}`)) {
                    delete logs[key];
                }
            });
            saveState();
            refreshUI();
            renderHabitList();
        }

        function clearAllLogs() {
            if (!confirm('Are you sure you want to clear all logs for this month? This cannot be undone.')) {
                return;
            }

            const monthKey = getMonthKey();
            const days = getDaysInMonth(currentYear, currentMonth);

            // Clear all logs for current month
            habits.forEach(h => {
                for (let d = 1; d <= days; d++) {
                    delete logs[`${monthKey}-${d}-${h.id}`];
                }
            });

            saveState();
            refreshUI();

            // Auto-sync with Google Sheets if connected
            const token = gapi.client?.getToken();
            if (gapiInited && token && SPREADSHEET_ID) {
                syncToGoogle().then(() => {
                    alert("All logs cleared and synced to Google Sheets!");
                }).catch(err => {
                    console.error("Sync after clear failed:", err);
                    alert("Logs cleared locally, but sync failed.");
                });
            } else {
                alert("All logs cleared!");
            }
        }

        function initMonthSelector() {
            // Initialize form fields only
            document.getElementById('apiKey').value = API_KEY;
            document.getElementById('clientId').value = CLIENT_ID;
            document.getElementById('sheetId').value = SPREADSHEET_ID;

            // Restore saved sheet name if available
            const savedSheetName = localStorage.getItem('g_sheet_name');
            if (savedSheetName) {
                document.getElementById('sheetNameDisplay').innerText = savedSheetName;
            }
        }

        function handleSheetIdChange() {
            SPREADSHEET_ID = document.getElementById('sheetId').value.trim();
            if (SPREADSHEET_ID) {
                localStorage.setItem('g_sheet_id', SPREADSHEET_ID);
                // Clear sheet name until we fetch it
                document.getElementById('sheetNameDisplay').innerText = "Loading...";
                // Auto-sync with new sheet if authenticated
                const token = gapi.client?.getToken();
                if (gapiInited && token) {
                    syncFromGoogle().then(() => {
                        console.log("Switched to new sheet and pulled data");
                    });
                }
            }
        }

        function handleModalSheetIdChange() {
            SPREADSHEET_ID = document.getElementById('sheetId').value.trim();
            if (SPREADSHEET_ID) {
                localStorage.setItem('g_sheet_id', SPREADSHEET_ID);
                // Clear sheet name until we fetch it
                document.getElementById('sheetNameDisplay').innerText = "Loading...";
                // Auto-sync with new sheet if authenticated
                const token = gapi.client?.getToken();
                if (gapiInited && token) {
                    syncFromGoogle().then(() => {
                        console.log("Switched to new sheet and pulled data");
                    });
                }
            }
        }

        window.onload = () => {
            initMonthSelector();
            const cloudToggle = document.getElementById('cloudSyncToggle');
            const savedCloudSync = localStorage.getItem('cloud_sync_enabled');
            const cloudSyncEnabled = savedCloudSync === 'true';
            setCloudSyncVisibility(cloudSyncEnabled);
            if (cloudToggle) {
                cloudToggle.checked = cloudSyncEnabled;
                cloudToggle.addEventListener('change', (event) => {
                    setCloudSyncVisibility(event.target.checked);
                });
            }
            refreshUI();
            gapiLoaded();

            // Display current origin for user to copy
            const originEl = document.getElementById('currentOrigin');
            if (originEl) {
                originEl.innerText = window.location.origin;
            }

            // Check if we have a valid token after GAPI loads - increased timeout
            setTimeout(() => {
                if (gapiInited && gapi.client?.getToken()) {
                    updateApiStatus();
                    document.getElementById('syncStatus').innerText = "Cloud Mode (Auto-restored)";
                }
            }, 1500);
        };

        // New function to fetch only the sheet name
        async function fetchSheetName() {
            if (!SPREADSHEET_ID || !gapiInited || !gapi.client.sheets) {
                return;
            }
            const token = gapi.client.getToken();
            if (!token) {
                return;
            }

            try {
                const metadataResponse = await gapi.client.sheets.spreadsheets.get({
                    spreadsheetId: SPREADSHEET_ID
                });

                const sheetName = metadataResponse.result.properties.title;
                document.getElementById('sheetNameDisplay').innerText = sheetName;
                localStorage.setItem('g_sheet_name', sheetName);
            } catch (err) {
                console.error("Failed to fetch sheet name:", err);
                document.getElementById('sheetNameDisplay').innerText = "Error loading name";
            }
        }
    </script>
    <!-- add "fixed" for floating footer -->
    <footer class=" bottom-4 left-0 w-full flex justify-center pointer-events-none">
        <nav class="pointer-events-auto bg-white/90 backdrop-blur shadow-sm border border-slate-200 rounded-full px-6 py-2 flex gap-4 text-xs font-semibold text-slate-600">
            <a href="about.html" class="hover:text-blue-600 transition">About</a>
            <span class="text-slate-300">‚Ä¢</span>
            <a href="privacy.html" class="hover:text-blue-600 transition">Privacy</a>
            <span class="text-slate-300">‚Ä¢</span>
            <a href="contact.html" class="hover:text-blue-600 transition">Contact</a>
        </nav>
    </footer>
</body>

</html>